name: ğŸ— Manual Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦ç¼–è¯‘çš„åˆ†æ”¯'
        required: true
        default: 'main'
        type: choice
        options:
          - weekfix
          - main
          - dev
          # å¦‚éœ€æ›´å¤šåˆ†æ”¯ï¼Œç»§ç»­å¾€ä¸‹åŠ 

jobs:
  build:
    runs-on: windows-latest
    steps:
      # 1. æ£€å‡ºæŒ‡å®šåˆ†æ”¯
      - name: ğŸ§¾ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      # 2. å®‰è£… Node
      - name: ğŸ§° Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. å®‰è£… Go
      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.2'
          cache: false

      # 4. å‰ç«¯ & åç«¯è”åˆæ„å»º
      - name: ğŸ— Build frontend & backend
        shell: pwsh
        working-directory: ${{ github.workspace }}
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 1
        run: |
          Write-Host "===== Build frontend ====="
          Remove-Item -Recurse -Force web/dist -ErrorAction SilentlyContinue
          cd web
          npm ci --silent --no-audit --no-fund
          npm run build
          if (-not (Test-Path dist)) {
              throw "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼Œdist ç›®å½•ä¸å­˜åœ¨"
          }
          cd ..

          Write-Host "===== Build backend ====="
          go mod tidy
          go build -ldflags="-s -w" -o auto-bgi.exe
          if (-not (Test-Path auto-bgi.exe)) {
              throw "âŒ Go ç¼–è¯‘å¤±è´¥ï¼Œauto-bgi.exe æœªç”Ÿæˆ"
          }

      # 5. ä¸Šä¼ äº§ç‰©
      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: auto-bgi-${{ github.event.inputs.branch }}-${{ github.run_number }}
          path: auto-bgi.exe
          retention-days: 30